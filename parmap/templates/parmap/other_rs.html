{% extends "parmap/parmap_base.html" %}
{% load i18n %}
{% load staticfiles %}
{% load url from future %}

{% block title %} 
RS {% if facettype == "layers" %} Layers {% else %} Maps {% endif %}
{% endblock %}

{% block body_class %}documents documents-list explore{% endblock %}

{% block body %}
    <div class = "landCoverTitleWrapper">
    <div class = "container">
        <a href = "javascript:;" class = "pull-right scrollToTop" style="display: none">back to top</a>
        <div class = "landCoverTitle">Other RS <b style='text-transform: capitalize;'>{{facettype}}</b></div>
    </div>
    </div>
    
    <div class="section firstChild backToTop" ng-controller="CartList">
        <div class = "container">
            <div class = "row">
                <div class = "col-sm-12 rightPanel">
                    <div class = "resultWrapper">
                        <div class = "resultTitle">
                            Results:
                            <a href="#" class="hidden browse-queue" data-toggle="modal" data-target="#browse-queue">Browse Queue</a>
                        </div>

                        <div class="modal fade" id="browse-queue" tabindex="-1" role="dialog" aria-labelledby="ResDownloadModalLabel" aria-hidden="true">
                          <div class="modal-dialog" style="width: 60%; min-height: 20%;">
                            <div class="modal-content" style="height: auto; min-height: 100%; border-radius: 0;">
                              <div class="modal-header">
                                <h4 class="modal-title" id="ResDownloadModalLabel">Other RS Queue</h4>
                              </div>
                              <div class="modal-body">
                                <div class="row edit-modal">
                                  <div class="col-sm-12 text-left">
                                    <ul class="queue-container"></ul>                                    
                                  </div>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <input type="button" class="btn btn-default js-btn-download" data-toggle="modal" value="{% trans "Download" %}"/>
                                <input type="button" class="btn btn-default" data-dismiss="modal" value="{% trans "Close" %}"/>
                              </div>
                            </div>
                          </div>
                      </div>
                        
                        <ul>
                        {% for item in list %}
                          <li>
                            <div class="resultImgWrapper resultImgWrapperRs">
                                <a href="{{ item.detail_url }}"><img src="{{ item.thumbnail_url }}" /></a>
                            </div>
                            <div class="description1"><a href="{{ item.detail_url }}">{{ item.title }}</a></div>
                            <div class="description2" style="text-transform: capitalize;">{{ item.category__gn_description }}</div>
                            <div class="description3">by <a href="/people/profile/{{ item.owner }}">{{ item.owner }}</a></div>
                            
                            {% if request.user.is_authenticated %}
                            <div class = "actions">
                              <a href="#" class="queue-item" 
                                data-url="{{item.detail_url}}" 
                                data-id="{{item.id}}"
                                data-title="{{item.title}}"
                                data-owner="{{item.owner}}"><i class = "fa fa-plus-square"></i> Add to Queue</a>
                              <a href="#" class="download-item" data-url="{{item.detail_url}}" data-id="{{item.id}}"><i class = "fa fa-download"></i>Download</a>
                            </div>
                            {% endif %}
                            <div class = "description4">
                              <p>{{item.abstract}}</p>
                            </div>		

                            <div class="modal fade" id="resource-download-{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="ResDownloadModalLabel" aria-hidden="true">
                              <div class="modal-dialog" style="width: 80%; height: 60%;">
                                <div class="modal-content" style="height: auto; min-height: 100%; border-radius: 0;">
                                  <div class="modal-header">
                                    <h4 class="modal-title" id="ResDownloadModalLabel">END-USER LICENSE AGREEMENT (Non-Commercial)</h4>
                                  </div>
                                  <div class="modal-body">
                                    <div class="row edit-modal">
                                      <div class="col-sm-12 text-left">
                                        {% include "parmap_data_request/eula.html" %}
                                      </div>
                                    </div>
                                  </div>
                                  <div class="modal-footer">
                                      {% if facettype == "layers" %}
                                        <input type="button" class="btn btn-default" data-toggle="modal" data-target="#download-layer-{{ item.id }}" data-dismiss="modal" value="{% trans "Accept" %}"/>
                                      {% else %}
                                        <a href="/documents/{{ item.id }}/download/" target="_blank">
                                          <input type="button" class="btn btn-default" value="{% trans "Accept" %}"/>
                                        </a>
                                      {% endif %}
                                    <input type="button" class="btn btn-default" data-dismiss="modal" value="{% trans "Close" %}"/>
                                  </div>
                                </div>
                              </div>
                            </div>
                        
                            <div class="modal fade" id="download-layer-{{ item.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                    <h4 class="modal-title" id="myModalLabel">{% trans "Download Layer" %}</h4>
                                  </div>
                                  <div class="modal-body parmap-download-list-{{ item.id }}">
                                      Download Links
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Close" %}</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                        
                        {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


    
  {% include "_bulk_permissions_form.html" %}
{% endblock %}

{% block extra_script %}
{% if GEONODE_SECURITY_ENABLED %}
  {% include "_permissions_form_js.html" %}
{% endif %}
<script type="text/javascript">

$(function (){
  $('.resultWrapper').on('click', '.download-item', function(evt){
    evt.preventDefault();
    var id = $(this).data('id');
    var urlArr = $(this).data('url').split('/');
    var item = urlArr[urlArr.length - 1];

    if ("{{facettype}}" == 'maps'){
      $('#resource-download-'+id).modal('show');
    }else{
      $.get('/parmap/other_rs/links/{{facettype}}/' + item, function(data){
        $('.parmap-download-list-'+id).html(data);
        $('#resource-download-'+id).modal('show');
      });
    }
  });

  var rsQueue = [];
  var queueContainer = $('.queue-container');

  $('.resultWrapper').on('click', '.queue-item', function(evt){
    evt.preventDefault();
    var urlArr = $(this).data('url').split('/');
    var item = urlArr[urlArr.length - 1];

    var targetItem = {
      id: $(this).data('id'),
      title: $(this).data('title'),
      owner: $(this).data('owner'),
      urlItem: item
    }

    var countQueue = rsQueue.filter(function(queue) {
      return queue.id === targetItem.id;
    });

    if(countQueue.length == 0){
      rsQueue.push(targetItem);
    }
    
    queueContainer.html(rsQueue.map(function(queue) {
      return '<li>' +
        '<div class="description1"><a href="#">' + queue.title + '</a></div>' +
        '<div class="description3">by <a href="/people/profile/' + queue.owner + '">' + queue.owner + '</a></div>' +
        '<div class="actions">' +
          '<a href="#" data-id="' + queue.id + '" class="remove-item"><i class="fa fa-remove"></i>Remove</a>' +
        '</div>' +
      '</li>';
    }));

    if(rsQueue.length > 0){
      $('.browse-queue').removeClass('hidden');
    }else{
      $('.browse-queue').addClass('hidden');
    }

    $('.js-btn-download').attr('disabled', false);
  })

  $('.queue-container').on('click', '.remove-item', function(evt) {
    evt.preventDefault();
    
    var self = this;
    var id = $(this).data('id');

    $.each(rsQueue, function(queueId, queue) {
      if(queue.id === id){
        $(self).parents('li').remove();
        rsQueue.splice(queueId, 1);
      }
    });

    if(rsQueue.length > 0){
      $('.browse-queue').removeClass('hidden');
    }else{
      $('.browse-queue').addClass('hidden');
      $('.js-btn-download').attr('disabled', true);
    }
  });
  
  $('.js-btn-download').on('click', function() {
    var queue = [];
    if("{{facettype}}" === 'maps'){
      rsQueue.forEach(function(rsItem) {
        queue.push(rsItem.id);
      })

      $.ajax({
        "url": "/parmap/other_rs/download/{{facettype}}",
        "type": "post",
        "data": {queue: queue},
        "success": function(data){
          console.log(data);
        },
        "error": function(err) {
          console.error(err);
        }
      })
    }else{
      rsQueue.forEach(function(rsItem) {
        queue.push(rsItem.id);
      })

      $.ajax({
        "url": "/gs/rs_download",
        "type": "post",
        "data": {queue: queue},
        "success": function(data){
          console.log(data);
        },
        "error": function(err) {
          console.error(err);
        }
      })
    }
    
  })

  
  $(".scrollToTop").click(function() {
			$('html,body').animate({scrollTop:0}, 500);
  });

  $(window).on('scroll', function(e){
    if(e.currentTarget.pageYOffset < 100){
      $(".scrollToTop").hide();
    }else{
      $(".scrollToTop").show();
    }
  })
  
});
</script>
{% with include_spatial='true' %}
{% include 'search/search_layer_scripts.html' %}
{% endwith %}
{% endblock extra_script %}
