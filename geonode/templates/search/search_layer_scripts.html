{% include "geonode/ext_header.html" %}
{% include "geonode/app_header.html" %}
{% include "geonode/geo_header.html" %}
<script type="text/javascript" src="{{ STATIC_URL}}geonode/js/utils/thumbnail.js"></script>
<script>

	var app;
	Ext.onReady(function() {
			GeoExt.Lang.set("en");
			var config = {
					tools: [{
							ptype: "gxp_wmsgetfeatureinfo",
							format: "grid",
							actionTarget: "main.tbar",
							outputConfig: {width: 400, height: 200, panIn: false}
					}],
					
					proxy: '/proxy/?url=',
					
					localGeoServerBaseUrl: "https://parmap.dream.upd.edu.ph/geoserver/",
					authorizedRoles: "ROLE_ANONYMOUS",

					/* The URL to a REST map configuration service.  This service 
					* provides listing and, with an authenticated user, saving of 
					* maps on the server for sharing and editing.
					*/
					rest: "/maps/",
					
					printService: "https://parmap.dream.upd.edu.ph/geoserver/pdf/",
					
					
					portalConfig: {
							renderTo: "mainMapView",
							height: 400 
					},

					listeners: {
							"ready": function() {
									var map = app.mapPanel.map;
									var layer = app.map.layers.slice(-1)[0];

									// FIXME(Ariel): Zoom to extent until #1795 is fixed.
									//map.zoomToExtent(layer.maxExtent, false)
									
									var bbox = layer.bbox;
									if (bbox != undefined)
									{
										if (!Array.isArray(bbox) && Object.keys(layer.srs) in bbox) {
											bbox = bbox[Object.keys(layer.srs)].bbox;
										}

										var extent = OpenLayers.Bounds.fromArray(bbox);
										var zoomToData = function()
										{
												map.zoomToExtent(extent, false);
												app.mapPanel.center = map.center;
												app.mapPanel.zoom = map.zoom;
												map.events.unregister('changebaselayer', null, zoomToData);
										};
										map.events.register('changebaselayer',null,zoomToData);
										if(map.baseLayer){
											map.zoomToExtent(extent, false);
										}
									}
							},
							"beforeunload": function() {
									if (modified) {
											styleEditor.show();
											return false;
									}
							}
					}
			};

			config = Ext.apply(config, {"defaultSourceType": "gxp_wmscsource", "about": {"abstract": "", "title": ""}, "map": {"layers": [{"opacity": 1, "group": "background", "args": ["No background"], "visibility": false, "source": "0", "fixed": true, "type": "OpenLayers.Layer"}, {"opacity": 1, "group": "background", "name": "mapnik", "visibility": true, "source": "1", "fixed": true, "type": "OpenLayers.Layer.OSM"}, {"opacity": 1, "group": "background", "name": "osm", "visibility": false, "source": "2", "fixed": false}, {"opacity": 1, "group": "background", "name": "naip", "visibility": false, "source": "2", "fixed": false}, {"opacity": 1, "source": "3", "fixed": false, "visibility": true}, {"opacity": 1.0, "name": "geonode:muni_metadata", "title": "muni_metadata", "selected": true, "visibility": true, "srs": "EPSG:900913", "bbox": [12447741.341886912, 506617.36871323036, 14118823.199903375, 2405557.1633768515], "getFeatureInfo": {"fields": ["city_munic", "province", "suc_hei", "muncode", "lulc_10k", "lulc_muni", "resource"], "propertyNames": {"province": null, "resource": null, "lulc_muni": null, "muncode": null, "city_munic": null, "suc_hei": null, "lulc_10k": null}}, "fixed": false, "queryable": true, "source": "4"}], "center": [0.0, -7.081154550627918e-10], "units": "m", "maxResolution": 156543.03390625, "maxExtent": [-20037508.34, -20037508.34, 20037508.34, 20037508.34], "zoom": 0, "projection": "EPSG:900913"}, "id": 0, "sources": {"1": {"ptype": "gxp_osmsource"}, "0": {"ptype": "gxp_olsource"}, "3": {"ptype": "gxp_mapboxsource"}, "2": {"ptype": "gxp_mapquestsource"}, "4": {"url": "https://parmap.dream.upd.edu.ph/geoserver/wms", "restUrl": "/gs/rest", "ptype": "gxp_wmscsource"}}});
			app = new GeoExplorer.Viewer(config);

			for (var key in app.tools) {
					var tool = app.tools[key];
					if (tool.ptype == 'gxp_styler') {
							tool.rasterStyling = true;
					};
			};

			// change style displayed in map
			Ext.get(Ext.DomQuery.select("input[@name='style']")).on("click", function(evt, elem) {
					app.selectedLayer.getLayer().mergeNewParams({
							"STYLES": elem.id,
							"_dc": Math.random()
					}); 
			});
			
			Ext.get(Ext.DomQuery.select(".style-edit")).on("click", function(evt, elem) {
					for (var key in app.tools) {
							var tool = app.tools[key];
							if (tool.ptype == 'gxp_styler') {
									tool.actions[0].execute();
							};
					}
			});
			Ext.Ajax.on('requestcomplete', function(req, cippa, opts){
					if(opts.method == 'PUT'){
							$('#legend_icon').attr('src', $('#legend_icon').attr('src')+'&'+Math.random());
					}   
			}, this);
	});

	var appSide;
	Ext.onReady(function() {
			GeoExt.Lang.set("en");
			var config = {
					tools: [{
							ptype: "gxp_wmsgetfeatureinfo",
							format: "grid",
							actionTarget: "main.tbar",
							outputConfig: {width: 400, height: 200, panIn: false}
					}],
					
					proxy: '/proxy/?url=',
					
					localGeoServerBaseUrl: "https://parmap.dream.upd.edu.ph/geoserver/",
					authorizedRoles: "ROLE_ANONYMOUS",

					/* The URL to a REST map configuration service.  This service 
					* provides listing and, with an authenticated user, saving of 
					* maps on the server for sharing and editing.
					*/
					rest: "/maps/",
					
					printService: "https://parmap.dream.upd.edu.ph/geoserver/pdf/",
					
					
					portalConfig: {
						renderTo: "mainMapViewSide",
							height: 400 
					},

					listeners: {
							"ready": function() {
									var map = appSide.mapPanel.map;
									var layer = appSide.map.layers.slice(-1)[0];

									// FIXME(Ariel): Zoom to extent until #1795 is fixed.
									//map.zoomToExtent(layer.maxExtent, false)
									
									var bbox = layer.bbox;
									if (bbox != undefined)
									{
										if (!Array.isArray(bbox) && Object.keys(layer.srs) in bbox) {
											bbox = bbox[Object.keys(layer.srs)].bbox;
										}

										var extent = OpenLayers.Bounds.fromArray(bbox);
										var zoomToData = function()
										{
												map.zoomToExtent(extent, false);
												appSide.mapPanel.center = map.center;
												appSide.mapPanel.zoom = map.zoom;
												map.events.unregister('changebaselayer', null, zoomToData);
										};
										map.events.register('changebaselayer',null,zoomToData);
										if(map.baseLayer){
											map.zoomToExtent(extent, false);
										}
									}
							},
							"beforeunload": function() {
									if (modified) {
											styleEditor.show();
											return false;
									}
							}
					}
			};

			config = Ext.apply(config, {"defaultSourceType": "gxp_wmscsource", "about": {"abstract": "", "title": ""}, "map": {"layers": [{"opacity": 1, "group": "background", "args": ["No background"], "visibility": false, "source": "0", "fixed": true, "type": "OpenLayers.Layer"}, {"opacity": 1, "group": "background", "name": "mapnik", "visibility": true, "source": "1", "fixed": true, "type": "OpenLayers.Layer.OSM"}, {"opacity": 1, "group": "background", "name": "osm", "visibility": false, "source": "2", "fixed": false}, {"opacity": 1, "group": "background", "name": "naip", "visibility": false, "source": "2", "fixed": false}, {"opacity": 1, "source": "3", "fixed": false, "visibility": true}, {"opacity": 1.0, "name": "geonode:muni_metadata", "title": "muni_metadata", "selected": true, "visibility": true, "srs": "EPSG:900913", "bbox": [12447741.341886912, 506617.36871323036, 14118823.199903375, 2405557.1633768515], "getFeatureInfo": {"fields": ["city_munic", "province", "suc_hei", "muncode", "lulc_10k", "lulc_muni", "resource"], "propertyNames": {"province": null, "resource": null, "lulc_muni": null, "muncode": null, "city_munic": null, "suc_hei": null, "lulc_10k": null}}, "fixed": false, "queryable": true, "source": "4"}], "center": [0.0, -7.081154550627918e-10], "units": "m", "maxResolution": 156543.03390625, "maxExtent": [-20037508.34, -20037508.34, 20037508.34, 20037508.34], "zoom": 0, "projection": "EPSG:900913"}, "id": 0, "sources": {"1": {"ptype": "gxp_osmsource"}, "0": {"ptype": "gxp_olsource"}, "3": {"ptype": "gxp_mapboxsource"}, "2": {"ptype": "gxp_mapquestsource"}, "4": {"url": "https://parmap.dream.upd.edu.ph/geoserver/wms", "restUrl": "/gs/rest", "ptype": "gxp_wmscsource"}}});
			appSide = new GeoExplorer.Viewer(config);

			for (var key in appSide.tools) {
					var tool = appSide.tools[key];
					if (tool.ptype == 'gxp_styler') {
							tool.rasterStyling = true;
					};
			};

			// change style displayed in map
			Ext.get(Ext.DomQuery.select("input[@name='style']")).on("click", function(evt, elem) {
					appSide.selectedLayer.getLayer().mergeNewParams({
							"STYLES": elem.id,
							"_dc": Math.random()
					}); 
			});
			
			Ext.get(Ext.DomQuery.select(".style-edit")).on("click", function(evt, elem) {
					for (var key in appSide.tools) {
							var tool = appSide.tools[key];
							if (tool.ptype == 'gxp_styler') {
									tool.actions[0].execute();
							};
					}
			});
			Ext.Ajax.on('requestcomplete', function(req, cippa, opts){
					if(opts.method == 'PUT'){
							$('#legend_icon').attr('src', $('#legend_icon').attr('src')+'&'+Math.random());
					}   
			}, this);
	});

</script>

<style>
	#mainMapViewSide {
		margin-top: 0;
	}

	#mainMapSideHolder #ext-comp-1009 {
		display: none;
	}
</style>